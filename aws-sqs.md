# AWS SQS

## Summary

Notes on using the aws SQS service

## Resources

[IAM Policy Lambda -> SNS](https://stackoverflow.com/questions/32211246/aws-sqs-permissions-for-aws-lambda)
[Monitoring](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-monitoring-using-cloudwatch.html)
[Cloudwatch Alarm Suggestions](https://www.bluematador.com/blog/how-to-monitor-amazon-sqs-with-cloudwatch)
[SQS FIFO -> LAMBDA](https://aws.amazon.com/blogs/compute/new-for-aws-lambda-sqs-fifo-as-an-event-source/)

## Tools

[Copy Messages Between Queues](https://github.com/scottjbarr/sqsmv)

## Use

- helps de-couple/loosely couple the environment
- supports multiple readers/writers in same queue
- single queue can be used by many components (kind of like subscriptions)
- engineered to provide 'at least once' delivery of all messages in queues

## Defaults

- Last In, First Out (LIFO\_) queue
- short polling

## Limitations

- 256KB text limit
- does not Guarantee First In, First Out (FIFO) delivery of messages
- Single request can have from 1 to 10 messages

## Billing

- billed at 64kb chunks
- first 1 million SQS requests per month are free
- \$0.50 per 1 million per month after free amount

## Delivery

SQS never pushes out - apps have to pull

## Timeout of Messages

- 12 hours visibility time out
- delivery timeout clock starts when message is picked up
- Component consuming message deletes it when done

## Does not handle Priority

You should use two separate SQS queues and have your app pull from the
'priority' queue first

## Use Cases

- generated by one AWS component to be consumed by another AWS component
- acts as a buffer between producer and consumer of data, good for when one is
  working faster than the other

## Example Flow

- Async pulls task message from queue
- Retrieves named file
- Processes conversion
- Writes image back to S3
- Writes a 'task complete' message to another queue
- Deletes the original task message
- Checks for more messages in the worker queue

## Polling Methods

[AWS Doc](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-long-polling.html)

`WaitTimeSeconds` settings between 1 and 20 takes priority over
`ReceiveMessageWaitTimeSeconds` settings

#### Short Polling

Only queries subset of servers

Settings:
Receive Message call with `waitTimeSeconds` set to `0`
Receive Message call with `ReceiveMessageWaitTimeSeconds` set to 0

#### Long Polling

queries all servers

helps reduce costs
eliminates false empty responses
Set ReceiveMessageWaitTime to betweeen 1 and 20 seconds

## SQS Messages Arriving Slowly

[Delay Seconds Docs](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-delay-queues.html)

Check the delivery delay. `DelaySeconds` is probably 90 seconds instead of 0 seconds

## SQS Message Being Processed Too Many Times

[Visiliby Timeout Docs](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-visibility-timeout.html)

Adjust the `VisibilityTimeout`. If the processing application / lambda takes 60
seconds to process the message, the default setting of `VisibilityTimeout: 30s`
will result in the message being processed multiple times.

## SQS ReceiveMessages API Call Taking Too Long

adjust the `waitTimeSeconds` to 1 second, so the api call will return in 1
second with any messages. 0 seconds will return messages in the queue
immediately.

## CloudWatch Metrics

Monitor `NumberOfMessagesSent` to determine if producer of messages has stopped
working.

Monitor `ApproximateAgeOfOldestMessage` to determine if messages are not being
processed quickly enough.
